// niccolo/bernardo by: davean & chromakode
Odlaw=function(e){this.path=e.imgPath,this.$el=$(e.el).addClass("bernardo-comic"),this.curPanel=null,this.$lastPanel=null,this.steps=[],this.scroll=e.scroll||!1,this.animate=e.animate||!1,this.overlay=e.overlay||!1},Odlaw.prototype={on:function(){this.$el.on.apply(this.$el,arguments)},advanceWithData:function(e){var t=this;e.comic&&this.init(e.comic);var n=[],r=[];e.deltas&&$.each(e.deltas,function(e,t){$.each(t.append_panels,function(e,t){r.length>0&&(r[r.length-1].next=t),r.push(t)})});if(r.length)return r[r.length-1].continuation=e.continuation,this.advancePanel(r[0]);this.curPanel=$.extend({},this.curPanel),this.curPanel.continuation=e.continuation,t.overlay&&t.showOverlay(e.continuation)},advancePanel:function(e){var t=this;return this.curPanel=e,this.addPanels([e],{animate:this.animate}).then(function(){t.overlay&&t.showOverlay(e.continuation)})},chooseOption:function(e){var t=$.extend({},this.curPanel.continuation);t.txt=e;var n=this._makeText(t);return this.$lastPanel.find(".option-placeholder").remove(),this.$lastPanel.append(n),this.steps.push({panel:this.curPanel,textEl:n,panelEl:this.$lastPanel,continuation:this.curPanel.continuation}),t},nextPanel:function(){return this.curPanel.next?(this.steps.push({panel:this.curPanel,panelEl:this.$lastPanel}),this.advancePanel(this.curPanel.next)):!1},init:function(e){this.pad=e.pad,this.$el.empty();var t=this;$("<div>").css({position:"absolute",top:0,left:0,bottom:0,right:0,"z-index":50}).attr("title",e.alt).appendTo(this.$el).on("click",function(){t.focusFirstOption()}),this.addPanels(e.panels)},addPanels:function(e){var t=this,n=this.path,r=[],i=[];return $.each(e,function(e,s){var o=$("<div>").addClass("panel").toggleClass("animate",t.animate).css({position:"relative",margin:t.pad}),u=new $.Deferred;r.push(u);var a=$("<img>").on("load error",function(){u.resolve()}).css({position:"static","vertical-align":"top"}).attr("src",n+s.background).appendTo(o);$.each(s.overlays,function(e,t){var r=$("<img>").css({position:"absolute",top:t.tl.y,left:t.tl.x}).attr("src",n+t.img).appendTo(o)}),$.each(s.texts,function(e,n){o.append(t._makeText(n))});var f={exists:!1,txts:[]};$.each(s.hints,function(e,n){n.pos?o.append(t._makeHint(n)):(f.exists=!0,n.href&&(f.href=n.href),n.txt&&f.txts.push(n.txt))}),f.exists&&(f.txts.length&&(f.txt=f.txts.join("\n")),o.append(t._makeHint(f))),i.push(o[0]),o.appendTo(t.$el),t.$lastPanel=o}),$.when.apply($,r).always(function(){$(i).css("opacity"),$(i).addClass("showing")})},_rgbaFromSpec:function(e){function t(e,t,n){n=n||0;var r=Math.pow(10,n);return Math.round(r*t*e)/r}return"rgba("+[t(e[0],255),t(e[1],255),t(e[2],255),t(e[3],1,2)].join(",")+")"},_comicText:function(e){return e&&e.replace(/\bi\b/gi,String.fromCharCode(1030))},_makeText:function(e){var t=e.align||"center";return $("<span>").css({position:"absolute",top:e.tl.y,left:e.tl.x,height:e.br.y-e.tl.y,width:e.br.x-e.tl.x,"text-align":t,"font-family":e.font,"font-size":e.size+"px",color:e.color?this._rgbaFromSpec(e.color):"black",overflow:"hidden"}).append($("<span>").css({position:"absolute",left:0,right:0,bottom:0}).text(this._comicText(e.txt)))},_makeHint:function(e){var t;return e.href?t=$("<a>").attr("href",e.href).attr("target","_blank").css("background","url(about:blank)"):t=$("<div>"),e.pos?t.css({top:e.pos.y,left:e.pos.x,width:e.size*2,height:e.size*2,margin:-e.size,"z-index":200}):t.css({top:0,left:0,bottom:0,right:0,"z-index":100}),t.css({position:"absolute"}).attr("title",e.txt),t},showPlaceholder:function(e){return this._makeText(e).addClass("option-placeholder").appendTo(this.$lastPanel)},showOverlay:function(e){function n(n){var r=$(n).find(".option-text, .option-writein");if(e){var i;if(r.is("input")){i=r.val();if(!i){r.focus();return}}else i=r.data("text");$overlayUI.remove();var s=t.chooseOption(i);t.$el.triggerHandler("chose",s)}else e==null&&($overlayUI.remove(),t.nextPanel())}function r(){if(!t.steps.length)return;var e=t.steps.pop();$overlayUI.remove(),$(e.textEl).remove();var n=$(e.panelEl);n.nextAll().remove(),t.$lastPanel=n,t.curPanel=e.panel,t.showOverlay(e.continuation)}var t=this,i=["a","b","c","d"],s=$('<ul class="options">');$overlayUI=$(s);if(e){var o=this.showPlaceholder(e);$overlayUI=$overlayUI.add(o),$.each(e.options,function(n,r){if(r===null){var o=$('<li class="option-line option-line-writein">').append($('<button class="option-choose" tabindex="2">').html(i.shift()),$('<div class="option-writein-box">').append($('<input class="option-writein" tabindex="1">').attr("placeholder","suggest a line...").css({"font-family":e.font,"font-size":e.size+"px"})));o.appendTo(s)}else{var u=$('<li class="option-line">').append($('<button class="option-choose" tabindex="1">').html(i.shift()),$('<div class="option-text">').attr("data-text",r).text(t._comicText(r)).css({"font-family":e.font,"font-size":e.size+"px"}));u.appendTo(s)}})}else if(e==null){var u=$('<li class="option-line">').append($('<button class="option-choose" tabindex="1">').html(i.shift()),$('<div class="option-text">').text("continue"));u.appendTo(s)}else if(e==0){s.addClass("final");var u=$('<li class="option-line">').append($('<button class="option-choose" tabindex="1">').html(i.shift()),$('<div class="option-text">').text("Suggestion submitted. Meanwhile, try exploring other choices!"));u.appendTo(s)}s.on("focusin focusout",".option-line",function(e){$(e.currentTarget).toggleClass("focus",e.type=="focusin")}).on("keydown",".option-choose, .option-writein",function(e){function i(n){t._focusOption($(e.target).closest(".option-line")[n]()),e.preventDefault()}e.which==38?i("prev"):e.which==40&&i("next"),e.which==37&&!$(e.target).val()&&r(),$(e.target).is(".option-choose")&&(e.which==39?n($(e.target).closest(".option-line")):e.which==75?i("prev"):e.which==74&&i("next"))}).on("keypress",".option-choose",function(e){var t=String.fromCharCode(e.which);t>="a"&&t<="d"&&(s.find(".option-choose:contains("+t+")").click(),e.preventDefault())}).on("keypress",".option-writein",function(e){e.which==13&&n($(e.target).closest(".option-line"))}).on("click",".option-line",function(e){$(e.target).is(".option-writein")||n($(e.currentTarget))});if(this.steps.length){var a=$('<button class="rollback" tabindex="1">').text("<").on("click",function(e){r()});$overlayUI=$overlayUI.add(a)}if(e&&e.node){var f=$('<a class="permalink" tabindex="1">').text("permalink").attr("href","/1350/#p:"+e.node);$overlayUI=$overlayUI.add(f)}$overlayUI.appendTo(this.$lastPanel).css("opacity"),$overlayUI.addClass("showing"),this.scroll&&this.scrollToOptions(),s&&this.focusFirstOption()},_focusOption:function(e){var t=$(e),n=$(window).scrollTop();t.is(".option-line-writein")?t.find(".option-writein").focus():t.find(".option-choose").focus(),$(window).scrollTop(n)},focusFirstOption:function(){this._focusOption(this.$lastPanel.find(".option-line:first"))},scrollToOptions:function(){var e=this.$lastPanel.find(".options");$("html, body").stop(!0).animate({scrollTop:e.offset().top+e.height()-window.innerHeight+50},350)}},Bernardo=function(){function e(e){return e[Math.floor(Math.random()*e.length)]}return{_csrfToken:null,_endpoint:function(t){return/^http:/.test(t)||(t=e(Bernardo.config.apiEndpoints)+(t||"")),t},ajax:function(e){var t=e.type&&e.type!="GET";return t&&(this._csrfToken=this._csrfToken||$.ajax({url:this._endpoint("csrf/token"),xhrFields:{withCredentials:!0}})),e.url=this._endpoint(e.url),e.xhrFields=e.xhrFields||{},e.xhrFields.withCredentials=!0,$.when(t&&this._csrfToken).then(function(t){return e.data=e.data||{},e.data["CSRF-Token"]=t,$.ajax(e)})},comic:function(e){var t=new Odlaw({el:e.el,imgPath:Bernardo.config.imgPath}),n=function(e){return t.advanceWithData(e)};t.on("chose",function(e,t){Bernardo.ajax({type:"post",url:"graph/1/"+t.node,data:{suggestion:t.txt}}).done(n)});var r;if(/^#p:/.test(location.hash)){var i=location.hash.substr(3);r=Bernardo.ajax({url:"graph/1/"+i}).then(function(e){var n=[];n.push(t.advanceWithData(e.steps.shift()));for(var r=0;r<e.path.length;r++){var i=e.steps[r],s=e.path[r];t.chooseOption(s),n.push(t.advanceWithData(i));var o;while(o=t.nextPanel())n.push(o)}return $.when.apply($,n)})}else r=Bernardo.ajax({url:"graph/1/"}).then(n);r.then(function(e){t.showOverlay(t.curPanel.continuation),t.scroll=!0,t.animate=!0,t.overlay=!0})}}}(),Bernardo.config={apiEndpoints:["//c.xkcd.com/"],imgPath:"//imgs.xkcd.com/comics/a1-2014/"};
